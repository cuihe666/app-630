Zepto(document).ready(function(){function t(t){var o=new Date(parseInt(t)),e=o.getFullYear(),c=o.getMonth()+1,s=o.getDate(),a=e+"-"+n(c)+"-"+n(s);return e&&c&&s?a:a="暂无可选日期"}function n(t){return t<10?"0"+t:t}function o(t){return/^1[34578]\d{9}$/.test(t)}function e(){var t=$("#calendar_top").height();$("#calendar_top").next().css("marginTop",t+"px")}var c=serveUrl(),s=zcGetLocationParm("tid"),a=zcGetLocationParm("item_type"),r=zcGetAndSetUid(),_="",i="",l=!1,u=0,d=c+"/api/couponnew/available",p={date:"",price:"",stock:10,childPrice:""},m=zc_store.get("userInfo","json_obj")||{date:"",parcount:1,childcount:0,price:"",childPrice:"",uname:"",utel:"",allpersons:[],stock:10,coupon:""},h=!zc_store.get("userInfo","json_obj"),f={0:"代金券",1:"满减券"},v={0:"daijin",1:"manjian"},w={0:"",1:"民宿",2:"旅行",3:"酒店"},z=function(){$(".goback").on("tap",U),$("#agree_pic").on("tap",Z),$("#agree_word").on("tap",Z),$(".experience_day_wp").on("tap",H),$(".pf_btn").on("tap",q),$(".c_rn_skwp .zc_min_btn").off("tap").on("tap",L),$(".c_rn_skwp .zc_add_btn").off("tap").on("tap",A),$(".child_skwp .zc_min_btn").off("tap").on("tap",M),$(".child_skwp .zc_add_btn").off("tap").on("tap",Y),$("#cnt_tel").on("blur",O),$("#contact_person").on("blur",S),$("#submit_order").on("tap",N),$("#coupon").on("tap",x),$(".use_intru").on("tap",j),$(".use_cancel").on("tap",I),$(".child_goback").on("tap",P),$(".use_sure").on("tap",b),$(".cld_cancel_btn").on("tap",g),$(".discount_wp").on("tap",".evy_privilege",C)};window.onunload=function(){};var C=function(){var t=$(this);currCnpId=t.find(".select_or_not").attr("data-id"),console.log(t.siblings()),t.find(".select_or_not").toggleClass("done_selt").end().siblings().find(".select_or_not.done_selt").removeClass("done_selt").find("img").attr("src","../img/list_youhuiquan_nor@3x.png"),t.find(".select_or_not").hasClass("done_selt")?t.find("img").attr("src","../img/list_youhuiquan_pre@3x.png"):t.find("img").attr("src","../img/list_youhuiquan_nor@3x.png")},g=function(){$(".start_day_wp").removeClass("show_out")},b=function(){var t=$(".counp_list_wp .select_or_not.done_selt");t.size()>0?(useCnpId=currCnpId,currCnpPrice=t.parents(".evy_privilege").attr("data-price"),$(".cpn_ed").addClass("show_out").find("#curr_cpn_pri").html(currCnpPrice),$(".can_use_count").removeClass("show_out")):(useCnpId=-1,currCnpPrice=0,$(".cpn_ed").removeClass("show_out").find("#curr_cpn_pri").html(currCnpPrice),$("#can_num").html()>0&&$(".can_use_count").addClass("show_out")),$("#zc_price").html(D("return_price")-currCnpPrice),$(".discount_wp").removeClass("show_out"),$("body").removeClass("hide"),$(".masker").removeClass("show_out")},k=function(){zc_store.remove("pageDataJson"),zc_store.remove("currScrollTop"),zc_store.remove("currTapCityCode"),zc_store.remove("currTapListJson")},y=function(t){var n=[];zc_store.get("userInfo");$(".cpn_ed").removeClass("show_out"),$(".can_use_count").addClass("show_out").find("#can_num").html(t.length),$.each(t,function(t,o){n.push("<div id="+o.id+' class="evy_privilege '+v[o.ruleType]+'" data-price='+o.amount+">",'<div class="coupon_name">'+f[o.ruleType]+"</div>",'<div class="coupon_name_value"><span class="rmb_sts">￥</span><span class="rmb_cnt">'+o.amount+"</span></div>",'<div class="cpn_name_detail">'+o.title+"</div>",X(o),'<div class="time_limit_wp">',"<span>有效期：</span>",V(o),"</div>",'<div class="select_or_not" data-id='+o.id+'><img src="../img/list_youhuiquan_nor@3x.png"></div>',"</div>")}),$(".counp_list_wp").html(n.join(""))},I=function(){useCnpId=currCnpId=-1,$(".discount_wp").removeClass("show_out"),$("body").removeClass("hide"),$(".masker").removeClass("show_out"),$(".counp_list_wp .select_or_not.done_selt").removeClass("done_selt").find("img").attr("src","../img/list_youhuiquan_nor@3x.png")},T=function(t){var n={uid:r,price:t,biz_type:2,houseId:s},o=JSON.stringify(n);$.ajax({type:"POST",contentType:"application/json;charset=UTF-8",url:d,data:o,success:function(t){var n=t.data;0==t.code&&(n.length>0?($(".no_counp").removeClass("show_out"),$(".counp_list_wp").css("display","block"),y(n)):($(".no_counp").addClass("show_out"),$(".counp_list_wp").html("").css("display","none"),$(".can_use_count").removeClass("show_out"),$(".cpn_ed.show_out").removeClass("show_out"),$("#can_num").html("0")))},error:function(){console.log("获取优惠券列表 ajax error")}})},P=function(){$(".yh_use_intru").removeClass("show_out")},j=function(){$(".yh_use_intru").addClass("show_out")},x=function(){$(".discount_wp").addClass("show_out"),$(".masker").addClass("show_out"),$("body").addClass("hide")},N=function(){var t=$("#agree_pic").hasClass("agr_before"),n=$.trim($("#contact_person").val()),o=$("#cnt_tel").val(),e=Number($(".c_rn_skwp .zc_cr_count").html()),c=Number($(".child_skwp .zc_cr_count").html()),a={},i="",l=window.location.href,u=$(".counp_list_wp .select_or_not.done_selt").attr("data-id");if(r=zcGetAndSetUid()){if(t)return $("#zc_remind_cnt").html("请阅读并同意棠果预订条款").addClass("show_out"),void setTimeout(function(){$("#zc_remind_cnt").html("").removeClass("show_out")},2e3);if(!n)return $("#zc_remind_cnt").html("请填写联系人").addClass("show_out"),void setTimeout(function(){$("#zc_remind_cnt").html("").removeClass("show_out")},2e3);if(!o)return $("#zc_remind_cnt").html("请填写联系电话").addClass("show_out"),void setTimeout(function(){$("#zc_remind_cnt").html("").removeClass("show_out")},2e3);if(m.stock<e+c)return $("#zc_remind_cnt").html("库存不够").addClass("show_out"),void setTimeout(function(){$("#zc_remind_cnt").html("").removeClass("show_out")},2e3);a.orderUid=r,a.travelId=s,a.activityDate=_||m.date||$("#detail_day").attr("data-day-date"),a.contacts=$("#contact_person").val(),a.mobilePhone=$("#cnt_tel").val(),a.anum=$(".c_rn_skwp .zc_cr_count").html(),u&&(a.couponId=u),i=JSON.stringify(a),F(i)}else applyAppLogin(l)},F=function(t){console.log(t);var n=c+"/api/activity/actorder";$.ajax({type:"POST",contentType:"application/json;charset=UTF-8",url:n,data:t,success:function(t){console.log(t);var n;8e4!=t.code?0==t.code&&(n=t.data.oid,t.data.orderNo,zc_store.remove("userInfo"),window.location.href="actyOrder_detail.html?orderId="+n+"&item_type="+a):$("#zc_remind_cnt").html("库存不够").addClass("show_out")},error:function(){console.log("ajax error")}})},S=function(){var t=$.trim($(this).val());m.uname=t,zc_store.set("userInfo",m)},O=function(){var t=$(this).val(),n=o(t);""==t&&(m.utel=t,zc_store.set("userInfo",m)),n?(m.utel=t,zc_store.set("userInfo",m)):$(this).val("")},U=function(){window.location.href="local_activity_detail.html?tid="+s+"&item_type="+a},q=function(){l&&($(".start_day_wp").removeClass("show_out"),$.extend(m,p),W(m),zc_store.set("userInfo",m))},D=function(t){var n=Number($("#c_rn_pri").html()),o=Number($("#et_pri").html()),e=n*Number($(".c_rn_skwp .zc_cr_count").html())+o*Number($(".child_skwp .zc_cr_count").html());if(e&&$("#zc_price").html(e),e&&t)return e;T(e)},G=function(){var t=Number($(".c_rn_skwp .zc_cr_count").html());t>1&&t<9?($(".c_rn_skwp .zc_min_btn").off("tap").on("tap",L),$(".c_rn_skwp .zc_add_btn").off("tap").on("tap",A)):t<=1?($(".c_rn_skwp .zc_min_btn").addClass("no_use"),$(".c_rn_skwp .zc_min_btn").off("tap")):t>=9&&($(".c_rn_skwp .zc_add_btn").addClass("no_use"),$(".c_rn_skwp .zc_add_btn").off("tap"))},J=function(){var t=Number($(".child_skwp .zc_cr_count").html());t>0&&t<9?($(".child_skwp .zc_min_btn").off("tap").on("tap",M),$(".child_skwp .zc_min_btn").removeClass("no_use")):t<=0?($(".child_skwp .zc_min_btn").off("tap"),$(".child_skwp .zc_min_btn").addClass("no_use")):t>=9&&($(".child_skwp .zc_add_btn").addClass("no_use"),$(".child_skwp .zc_add_btn").off("tap"))},L=function(){var t=$(".c_rn_skwp .zc_cr_count").html();t>=9&&($(".c_rn_skwp .zc_add_btn").removeClass("no_use"),$(".c_rn_skwp .zc_add_btn").off("tap").on("tap",A)),t>1&&($(".c_rn_skwp .zc_cr_count").html(--t),D(),G(),m.parcount=t,zc_store.set("userInfo",m))},A=function(){var t=$(".c_rn_skwp .zc_cr_count").html();1==t&&$(".c_rn_skwp .zc_min_btn").removeClass("no_use"),t<9&&($(".c_rn_skwp .zc_cr_count").html(++t),D(),G(),m.parcount=t,zc_store.set("userInfo",m))},M=function(){var t=$(".child_skwp .zc_cr_count").html();t>=9&&($(".child_skwp .zc_add_btn").removeClass("no_use"),$(".child_skwp .zc_add_btn").off("tap").on("tap",Y)),t>0&&($(".child_skwp .zc_cr_count").html(--t),D(),J(),m.childcount=t,zc_store.set("userInfo",m))},Y=function(){var t=$(".child_skwp .zc_cr_count").html();t<9&&($(".child_skwp .zc_cr_count").html(++t),D(),J(),m.childcount=t,zc_store.set("userInfo",m))},H=function(){$(".start_day_wp").addClass("show_out"),e()},Z=function(){$("#agree_pic").toggleClass("agr_before")},B=function(){var t=c+"/api/activity/pricedate";$.ajax({url:t,data:{actId:s},success:function(t){var n=t.data,o=n[0];h&&($.extend(m,o),W(m)),E(n)}})},E=function(t){var n=new Date,o={c:"calendarcontainer",y:n.getFullYear(),m:n.getMonth()+1,a:{d1:"2014-01-30",d2:"2014-05-05"},f:11,clickfu:function(t){console.log(t),$(t).attr("id")&&(console.log(p.stock),p.stock=u=$(t).find(".curr_btg_info").attr("data-stock"),console.log(p.stock),i=$(t).attr("id"),p.date=_=$(t).find(".curr_btg_info").attr("data-day"),l=!0,p.childPrice=$(t).find(".curr_btg_info").attr("data-childprice"),p.price=$(t).find(".curr_btg_info").attr("data-price"))},showFu:function(n){return Q(n.getTime(),K(t))}};CreateCalendar(o)},K=function(t){var n={};return $.each(t,function(t,o){n[o.date]=o}),n},Q=function(t,n){var o={};return n[t]?'<b class="curr_btg_info" style="display:block" data-stock='+(o=n[t]).stock+" data-day="+o.date+" data-childPrice="+o.childPrice+' >￥<span class="curr_day_price">'+o.price+"</span></b>":""},R=function(t){$("#crn_sk").html(t),t<10?$(".remain_stock").addClass("show_out"):$(".remain_stock").removeClass("show_out")},V=function(n){var o="",e=[];return 1==n.isForever||"true"==n.isForever?o="永久有效":n.isForever&&"false"!=n.isForever||(e.push('<span class="start_time">'+t(n.startTime)+"</span>",'<span class="start_time">-</span>','<span class="start_time">'+t(n.endTime)+"</span>"),o=e.join("")),o},W=function(n){console.log(n);var o=n.allpersons;$("#detail_day").html(t(n.date)),$(".c_rn_skwp .zc_cr_count").html(n.parcount),$(".child_skwp .zc_cr_count").html(n.childcount),$("#contact_person").val(n.uname),n.utel&&$("#cnt_tel").val(Number(n.utel)),$("#c_rn_pri").html(n.price),$("#et_pri").html(n.childPrice),R(n.stock),$.each(o,function(t,n){}),n.coupon&&$("#coupon").html(n.coupon),G(),J(),D()},X=function(t){var n="";return 1==t.ruleType&&(n='<div class="least_info">满<span class="manCOunt">'+t.rule+"</span>元可用</div>"),0==t.ruleType&&(n=0==t.rule?'<div class="least_info">全场<span class="itm_type">'+w[t.type]+"</span>产品可用</div>":'<div class="least_info">全场<span class="itm_type">'+w[t.type]+"</span>产品满<span>"+t.rule+"</span>元可用</div>"),n};z(),B(),!h&&W(m),k()}),window.onload=function(){solveIosHead()};